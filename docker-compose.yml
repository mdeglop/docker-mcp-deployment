version: '3.8'

# Complete MCP Gateway + n8n-MCP deployment for Hostinger VPS
# Ubuntu 24.04 Headless Server
# 2 CPU cores, 8GB RAM, 100GB disk

services:
  # Docker MCP Gateway (runs in container for headless servers)
  mcp-gateway:
    image: ghcr.io/docker/mcp-gateway:latest
    container_name: mcp-gateway
    restart: unless-stopped
    ports:
      - "127.0.0.1:8811:8811"  # Only expose to localhost (Caddy will reverse proxy)
    volumes:
      # Mount Docker socket so gateway can manage containers
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Configuration and catalog storage
      - ./mcp-config:/root/.docker/mcp
      - ./mcp-data:/data
    environment:
      # Gateway configuration
      - MCP_GATEWAY_PORT=8811
      - MCP_GATEWAY_TRANSPORT=sse  # Server-Sent Events for remote access
      - MCP_GATEWAY_HOST=0.0.0.0
      # Logging
      - LOG_LEVEL=info
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8811/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # n8n-MCP Server (for workflow documentation & management)
  n8n-mcp:
    image: ghcr.io/czlonkowski/n8n-mcp:latest
    container_name: n8n-mcp
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"  # Only expose to localhost
    environment:
      # Core configuration
      - MCP_MODE=http
      - USE_FIXED_HTTP=true
      - NODE_ENV=production

      # Authentication (CHANGE THESE!)
      - AUTH_TOKEN=${N8N_MCP_AUTH_TOKEN}
      - MCP_AUTH_TOKEN=${N8N_MCP_AUTH_TOKEN}

      # Connect to n8n instance
      - N8N_API_URL=http://n8n:5678
      - N8N_API_KEY=${N8N_API_KEY}

      # Networking
      - HOST=0.0.0.0
      - PORT=3000
      - TRUST_PROXY=1
      - BASE_URL=https://${DOMAIN}/n8n-mcp

      # Security (v2.16.3+)
      - AUTH_RATE_LIMIT_WINDOW=900000  # 15 minutes
      - AUTH_RATE_LIMIT_MAX=50  # Allow more for development
      - WEBHOOK_SECURITY_MODE=moderate  # Allows localhost n8n

      # Logging
      - LOG_LEVEL=info
    volumes:
      - n8n-mcp-data:/app/data
    networks:
      - mcp-network
    depends_on:
      n8n:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M

  # n8n Workflow Automation (your existing instance)
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "127.0.0.1:5678:5678"  # Only expose to localhost
    environment:
      # Basic configuration
      - N8N_HOST=${DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${DOMAIN}/

      # Database (using SQLite for simplicity, switch to PostgreSQL for production)
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=/home/node/.n8n/database.sqlite

      # Security
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}

      # Timezone
      - GENERIC_TIMEZONE=America/New_York  # Change to your timezone
      - TZ=America/New_York

      # Execution mode
      - EXECUTIONS_MODE=regular
      - N8N_METRICS=true

      # Logging
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console
    volumes:
      - n8n-data:/home/node/.n8n
      - n8n-files:/files
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 1G

  # Caddy Reverse Proxy (automatic HTTPS)
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    environment:
      - DOMAIN=${DOMAIN}
    networks:
      - mcp-network
    depends_on:
      - mcp-gateway
      - n8n-mcp
      - n8n
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Portainer (optional but recommended for container management)
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "127.0.0.1:9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - portainer-data:/data
    networks:
      - mcp-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

networks:
  mcp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  n8n-data:
    driver: local
  n8n-files:
    driver: local
  n8n-mcp-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
  portainer-data:
    driver: local

# Resource Summary (total):
# CPU: Up to 4 cores (within your 2 core limit due to Docker overhead)
# RAM: Up to 6.25GB (within your 8GB)
# Disk: ~5-10GB for images + your data
