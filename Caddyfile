# Caddy configuration for MCP Gateway + n8n
# Automatic HTTPS with Let's Encrypt

# Main domain configuration
{$DOMAIN} {
    # Enable compression
    encode gzip

    # n8n Workflow UI (main interface)
    reverse_proxy n8n:5678 {
        # Forward client IP
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}

        # WebSocket support for n8n
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}
    }
}

# MCP Gateway endpoint (for remote MCP clients)
mcp.{$DOMAIN} {
    encode gzip

    # Docker MCP Gateway
    reverse_proxy mcp-gateway:8811 {
        # SSE support
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}

        # Forward client IP for rate limiting
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # SSE-specific headers
        header_down Cache-Control "no-cache"
        header_down Connection "keep-alive"

        # Longer timeout for SSE
        flush_interval -1
    }

    # Health check endpoint (no auth required)
    handle /health {
        reverse_proxy mcp-gateway:8811
    }
}

# n8n-MCP Server endpoint (for n8n MCP Client Tool)
n8n-mcp.{$DOMAIN} {
    encode gzip

    # n8n-MCP HTTP Server
    reverse_proxy /mcp* n8n-mcp:3000 {
        # Forward authentication headers
        header_up Authorization {>Authorization}

        # Forward client IP
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # SSE support (n8n-MCP uses streamable HTTP)
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}

        # Longer timeout
        flush_interval -1
    }

    # Health endpoint (no auth)
    handle /health {
        reverse_proxy n8n-mcp:3000
    }
}

# Portainer UI (optional - for container management)
portainer.{$DOMAIN} {
    encode gzip

    reverse_proxy portainer:9000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Redirect www to non-www (if desired)
www.{$DOMAIN} {
    redir https://{$DOMAIN}{uri} permanent
}

# Security headers (applied to all sites)
(security_headers) {
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"

        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"

        # Enable XSS protection
        X-XSS-Protection "1; mode=block"

        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Permissions policy
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        # Remove server header
        -Server
    }
}

# Apply security headers to all sites
{$DOMAIN} {
    import security_headers
}
mcp.{$DOMAIN} {
    import security_headers
}
n8n-mcp.{$DOMAIN} {
    import security_headers
}
